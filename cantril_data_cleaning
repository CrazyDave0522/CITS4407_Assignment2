#!/bin/bash

# Description
## This script is designed to clean the data based on certain rules (see below).

# Input: This script expects three .tsv files,
## which are `gdp-vs-happiness.tsv`, `homicide-rate-unodc.tsv`, `life-satisfaction-vs-life-expectancy.tsv`.
## The input files may be in any order.

# Output: A tab-separated data directed to standard output.
## Based on the header line, make sure that the file is a tab-separated format file
## Also based on the header line, report any lines that do not have the same number of cells. (Cells are allowed to be empty.)
## Remove the column with header `Continent`.
## Ignore the rows where the country code field is empty.
## Only keep the rows with years from 2011 to 2021, inclusive.
## The output file sent to stdout has rows with the data in the following order (tab separated):
## <Entity/Country> <Code> <Year> <GDP per capita> <Population> <Homicide Rate> <Life Expectancy> <Cantril Ladder score>

# Author: Zixiao Ma (24116864)

# Created Date: 17 May 2024

# Function to check if a file is tab-separated and has a consistent number of cells per row
check_file() {
    local file=$1
    local header=$(head -n 1 "$file")
    local num_columns=$(echo "$header" | awk -F'\t' '{print NF}')
    local line_num=1

    while IFS= read -r line; do
        local num_cells=$(echo "$line" | awk -F'\t' '{print NF}')
        if [[ $num_cells -ne $num_columns ]]; then
            echo "Warning: Line $line_num in $file does not have $num_columns cells." >&2
        fi
        ((line_num++))
    done <"$file"
}

# Function to remove the "Continent" column from the file
remove_continent_column() {
    local file=$1
    awk -F'\t' '
        {
            # Print each row excluding the 7th column (Continent),
            # since the order of the columns will not change
            for (i = 1; i <= NF; i++) {
                if (i != 7) {
                    printf "%s", $i
                    if (i < NF && i != 6) {
                        printf "\t"
                    }
                }
            }
            printf "\n"
        }
    ' OFS='\t' "$file"
}

# Function to remove rows where the country code field is empty
remove_empty_country_code() {
    local file=$1
    awk -F'\t' '
        NR==1 {
            # Print header
            print $0
        }
        NR > 1 {
            # Only include rows with non-empty country code
            if ($2 != "") {
                print $0
            }
        }
    ' OFS='\t' "$file"
}

# Function to filter rows by the year range (2011-2021)
filter_by_year() {
    local file=$1
    awk -F'\t' '
        NR==1 {
            # Print header
            print $0
        }
        NR > 1 {
            # Only include rows with years 2011-2021
            if ($3 >= 2011 && $3 <= 2021) {
                print $0
            }
        }
    ' OFS='\t' "$file"
}

# Function to sort the data based on
# the combination of the second(code) and third(year) column
sort_data() {
    {
        read -r header
        echo "$header"
        sort -t $'\t' -k2,2 -k3,3n
    }
}



# Main Script
## Input check
### Check if the correct number of arguments is provided
if [[ "$#" -ne 3 ]]; then
    echo "Usage: $0 gdp-vs-happiness.tsv homicide-rate-unodc.tsv life-satisfaction-vs-life-expectancy.tsv" >&2
    exit 1
fi

### Check if the data files exist
for file in "$1" "$2" "$3"; do
    if [[ ! -s "$file" ]]; then
        echo "The input file $file does not exist or has zero length" >&2
        exit 1
    fi
done

# Check each file
for file in "$@"; do
    check_file "$file"
done
echo "All file process done"

# Determine the order of files
for file in "$@"; do
    case "$file" in
    *gdp-vs-happiness.tsv)
        gdp_happiness="$file"
        ;;
    *homicide-rate-unodc.tsv)
        homicide_rate="$file"
        ;;
    *life-satisfaction-vs-life-expectancy.tsv)
        life_satisfaction="$file"
        ;;
    *)
        echo "Unexpected file: $file" >&2
        exit 1
        ;;
    esac
done
echo "File order determined"

# Process and store cleaned data into temporary files
remove_continent_column "$gdp_happiness" | remove_empty_country_code | filter_by_year | sort_data >gdp_happiness_cleaned.tsv
remove_empty_country_code "$homicide_rate" | filter_by_year | sort_data >homicide_rate_cleaned.tsv
remove_continent_column "$life_satisfaction" | remove_empty_country_code | filter_by_year | sort_data >life_satisfaction_cleaned.tsv
